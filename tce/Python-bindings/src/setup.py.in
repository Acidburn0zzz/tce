#!/usr/bin/env python

#
# Python distutils file for building and installing the
# TCE Python bindings. To find out what you can do with
# it, run "python setup.py --help".

from distutils.core import setup, Extension
import os

project_root = os.path.abspath('../..')

def maybe(str):
    if str == '':
        return []
    else:
        return [str]

def strip2(str):
    """Strip leading two characters from a string"""
    return str[2:]

TCE_includes=([filename % project_root
               for filename in ['%s',
                                '%s/src/tools',
                                '%s/src/base/mach',
                                '%s/src/base/umach',
                                '%s/src/base/osal',
                                '%s/src/base/program',
                                '%s/src/base/tpef',
                                '%s/src/base/memory',
                                '%s/src/base/Graph',
                                '%s/src/applibs/Simulator',
                                '%s/src/applibs/Interpreter',
                                '%s/src/applibs/TraceDB',
                                '%s/src/applibs/Scheduler',
                                '%s/src/applibs/Scheduler/Algorithms',
                                '%s/src/applibs/Scheduler/ProgramRepresentations/DataDependenceGraph',
                                '%s/src/applibs/Scheduler/ProgramRepresentations/ProgramDependenceGraph',
                                '%s/src/applibs/Scheduler/ProgramRepresentations/ControlFlowGraph',
                                '%s/src/applibs/Scheduler/ResourceModel',
                                '%s/src/applibs/Scheduler/ResourceManager',
                                '%s/src/applibs/Scheduler/Selector',
                                '%s/scheduler/passes/BasicBlockScheduler']]
              + maybe(strip2("@TCL_INCLUDES@"))
              + maybe(strip2("@BOOST_INCLUDES@"))
              + maybe(strip2("@SQLITE_INCLUDES@"))
              + maybe(strip2("@XERCES_INCLUDES@"))
              + maybe(strip2("@EDITLINE_INCLUDES@")))

TCE_library_dirs=([dir % project_root
                   for dir in ['%s/src/base/.libs',
                               '%s/src/tools/.libs',
                               '%s/src/applibs/.libs']]
                  + maybe(strip2("@TCL_LIBDIR@"))
                  + maybe(strip2("@BOOST_LIBDIR@"))
                  + maybe(strip2("@SQLITE_LIBDIR@"))
                  + maybe(strip2("@XERCES_LIBDIR@"))
                  + maybe(strip2("@EDITLINE_LIBDIR@")))

TCE_libraries=['ttabase',
               'tcetools',
               'applibs',
               strip2('@TCL_LD_FLAGS@').strip(),
               'boost_filesystem',
               'boost_regex',
               'boost_python',
               'sqlite3',
               'xerces-c']

TCE_define_macros=[('BOOST_PYTHON_DYNAMIC_LIB', None)]

setup(name='TCE Python bindings',
      version='0.1',
      description='Set of Python modules to access TCE libraries',
      author='Pertti Kellomaki',
      author_email='pertti.kellomaki@tut.fi',
      packages=['TCE',
                'TCE.base',
                'TCE.applibs',
                'TCE.applibs.Scheduler',
                'TCE.applibs.Scheduler.ProgramRepresentations'],
      ext_modules=[Extension('TCE.base.mach',
                             ['mach.cc'],
                             depends=['../../src/base/mach/Bus.hh',
                                      '../../src/base/mach/FunctionUnit.hh',
                                      '../../src/base/mach/Machine.hh',
                                      '../../src/base/mach/Port.hh',
                                      '../../src/base/mach/RFPort.hh',
                                      '../../src/base/mach/ControlUnit.hh',
                                      '../../src/base/mach/Segment.hh',
                                      '../../src/base/mach/Guard.hh',
                                      '../../src/base/mach/HWOperation.hh',
                                      '../../src/base/mach/PipelineElement.hh',
                                      '../../src/base/osal/OperationContext.hh',
                                      '../../src/base/osal/Operation.hh',
                                      '../../src/base/osal/OperationPool.hh',                                      
                                      '../../src/tools/SimValue.hh',
                                      '../../src/base/umach/UniversalMachine.hh',
                                      ],
                             define_macros=TCE_define_macros,
                             include_dirs=TCE_includes,
                             library_dirs=TCE_library_dirs,
                             libraries=TCE_libraries),
                   Extension('TCE.tools',
                             ['tools.cc'],
                             depends = ['../../src/tools/SimValue.hh'],
                             define_macros=TCE_define_macros,
                             include_dirs=TCE_includes,
                             library_dirs=TCE_library_dirs,
                             libraries=TCE_libraries
                             ),
                   Extension('TCE.base.program',
                             ['program.cc'],
                             depends = ['../../src/base/program/Address.hh',
                                        '../../src/base/program/CodeLabel.hh',
                                        '../../src/base/program/CodeSnippet.hh',
                                        '../../src/base/program/DataLabel.hh',
                                        '../../src/base/program/GlobalScope.hh',
                                        '../../src/base/program/Immediate.hh',
                                        '../../src/base/program/Instruction.hh',
                                        '../../src/base/program/InstructionReference.hh',
                                        '../../src/base/program/InstructionReferenceManager.hh',
                                        '../../src/base/program/Label.hh',
                                        '../../src/base/program/Move.hh',
                                        '../../src/base/program/MoveGuard.hh',
                                        '../../src/base/program/NullAddress.hh',
                                        '../../src/base/program/NullGlobalScope.hh',
                                        '../../src/base/program/NullImmediate.hh',
                                        '../../src/base/program/NullInstruction.hh',
                                        '../../src/base/program/NullInstructionReferenceManager.hh',
                                        '../../src/base/program/NullMove.hh',
                                        '../../src/base/program/NullMoveGuard.hh',
                                        '../../src/base/program/NullProcedure.hh',
                                        '../../src/base/program/NullProgram.hh',
                                        '../../src/base/program/NullTerminal.hh',
                                        '../../src/base/program/Procedure.hh',
                                        '../../src/base/program/Program.hh',
                                        '../../src/base/program/ProgramWriter.hh',
                                        '../../src/base/program/Scope.hh',
                                        '../../src/base/program/TPEFProgramFactory.hh',
                                        '../../src/base/program/TerminalAddress.hh',
                                        '../../src/base/program/TerminalFUPort.hh',
                                        '../../src/base/program/TerminalImmediate.hh',
                                        '../../src/base/program/TerminalInstructionAddress.hh',
                                        '../../src/base/program/TerminalRegister.hh',
                                        '../../src/base/osal/Operation.hh',
                                        '../../src/base/mach/HWOperation.hh',
                                        '../../src/base/mach/Guard.hh',
                                        '../../src/base/program/DataMemory.hh'],
                             define_macros=TCE_define_macros,
                             include_dirs=TCE_includes,
                             library_dirs=TCE_library_dirs,
                             libraries=TCE_libraries),
                   Extension('TCE.base.tpef',
                             ['tpef.cc'],
                             depends = ['../../src/base/tpef/Binary.hh',
                                        '../../src/base/tpef/BinaryReader.hh',
                                        '../../src/base/tpef/BinaryStream.hh'],
                             define_macros=TCE_define_macros,
                             include_dirs=TCE_includes,
                             library_dirs=TCE_library_dirs,
                             libraries=TCE_libraries),
                   Extension('TCE.base.osal',
                             ['osal.cc'],
                             depends = ['../../src/base/osal/Operation.hh'],
                             define_macros=TCE_define_macros,
                             include_dirs=TCE_includes,
                             library_dirs=TCE_library_dirs,
                             libraries=TCE_libraries),
                   Extension('TCE.applibs.Scheduler.ProgramRepresentations.ProgramDependenceGraph',
                             ['ProgramDependenceGraph.cc'],
                             depends = ['../../src/applibs/Scheduler/ProgramRepresentations/ProgramDependenceGraph/MoveNode.hh',
                                        '../../src/applibs/Scheduler/ProgramRepresentations/ProgramDependenceGraph/ProgramOperation.hh'],
                             define_macros=TCE_define_macros,
                             include_dirs=TCE_includes,
                             library_dirs=TCE_library_dirs,
                             libraries=TCE_libraries),
                   Extension('TCE.applibs.Scheduler.ResourceManager',
                             ['ResourceManager.cc'],
                             depends = ['../../src/applibs/Scheduler/ResourceManager/SimpleResourceManager.hh',
                                        '../../src/base/program/Instruction.hh',
                                        '../../src/applibs/Scheduler/ProgramRepresentations/ProgramDependenceGraph/MoveNode.hh',
                                        '../../src/base/mach/Machine.hh'],
                             define_macros=TCE_define_macros,
                             include_dirs=TCE_includes,
                             library_dirs=TCE_library_dirs,
                             libraries=TCE_libraries),
                   Extension('TCE.applibs.Scheduler.ResourceModel',
                             ['ResourceModel.cc'],
                             depends = ['../../src/applibs/Scheduler/ResourceModel/BusResource.hh',
                                        '../../src/applibs/Scheduler/ResourceModel/ExecutionPipelineResource.hh',
                                        '../../src/applibs/Scheduler/ResourceModel/FUResource.hh',
                                        '../../src/applibs/Scheduler/ResourceModel/ITemplateResource.hh',
                                        '../../src/applibs/Scheduler/ResourceModel/IUResource.hh',
                                        '../../src/applibs/Scheduler/ResourceModel/InputFUResource.hh',
                                        '../../src/applibs/Scheduler/ResourceModel/InputPSocketResource.hh',
                                        '../../src/applibs/Scheduler/ResourceModel/OutputFUResource.hh',
                                        '../../src/applibs/Scheduler/ResourceModel/OutputPSocketResource.hh',
                                        '../../src/applibs/Scheduler/ResourceModel/PSocketResource.hh',
                                        '../../src/applibs/Scheduler/ResourceModel/SchedulingResource.hh',
                                        '../../src/applibs/Scheduler/ResourceModel/SegmentResource.hh',
                                        '../../src/applibs/Scheduler/ResourceModel/ShortImmPSocketResource.hh'],
                             define_macros=TCE_define_macros,
                             include_dirs=TCE_includes,
                             library_dirs=TCE_library_dirs,
                             libraries=TCE_libraries),
                   Extension('TCE.applibs.Scheduler.ProgramRepresentations.ControlFlowGraph',
                             ['ControlFlowGraph.cc'],
                             depends = ['../../src/applibs/Scheduler/ProgramRepresentations/ControlFlowGraph/BasicBlockNode.hh',
                                        '../../src/applibs/Scheduler/ProgramRepresentations/ControlFlowGraph/ControlFlowEdge.hh',
                                        '../../src/applibs/Scheduler/ProgramRepresentations/ControlFlowGraph/ControlFlowGraph.hh',
                                        '../../src/applibs/Scheduler/ProgramRepresentations/ControlFlowGraph/CFGStatistics.hh',
                                        '../../src/base/Graph/Graph.hh',
                                        '../../src/base/Graph/BoostGraph.hh',
                                        '../../src/base/Graph/GraphEdge.hh',
                                        '../../src/base/Graph/GraphNode.hh',
                                        '../../src/base/mach/AddressSpace.hh',
                                        '../../src/base/program/Procedure.hh'],
                             define_macros=TCE_define_macros,
                             include_dirs=TCE_includes,
                             library_dirs=TCE_library_dirs,
                             libraries=TCE_libraries),                             
                   Extension('TCE.applibs.Scheduler.SchedulerModules',
                             ['SchedulerModules.cc'],
                             depends = ['../../src/applibs/Scheduler/BaseSchedulerModule.hh',
                                        '../../src/applibs/Scheduler/HelperSchedulerModule.hh'],
                             define_macros=TCE_define_macros,
                             include_dirs=TCE_includes,
                             library_dirs=TCE_library_dirs,
                             extra_link_args=['%s/scheduler/passes/BasicBlockScheduler/CLBBypasserModule.so'
                                              % project_root,
                                              '%s/scheduler/passes/BasicBlockScheduler/CopyingDSFillerModule.so'
                                              % project_root,
                                              ],
                             libraries=TCE_libraries),                             
                   Extension('TCE.applibs.Scheduler.Algorithms',
                             ['Algorithms.cc'],
                             depends = [
                                        ],
                             define_macros=TCE_define_macros,
                             include_dirs=TCE_includes,
                             library_dirs=TCE_library_dirs,
                             libraries=TCE_libraries),                             
                   ]
)
      
     
