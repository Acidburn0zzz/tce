AT_SETUP([context data is passed to internal functions])

AT_DATA([main.c],[
#include <stdio.h>

void f(char *s);

int main(int argc, char *argv[[]]) {
    char s[[]] = "OK\n";

    f(s);

    return 0;
}

void g(char *s) {
    printf(s);
}
])

AT_DATA([context.c],[
void g(void);

void f(void) {
    g();
}
])

#$LLVMCC $LLVMCFLAGS -c --emit-llvm test.c
llvm-gcc -c --emit-llvm main.c
llvm-gcc -c --emit-llvm context.c
AT_CHECK([opt -load=$abs_top_builddir/lib/.libs/llvmopencl.so -add-context \
          context.o -o opencl_context.o])
AT_CHECK([llvm-link -o test.o main.o opencl_context.o
AT_CHECK([lli test.o], 0, [OK
])

AT_CLEANUP