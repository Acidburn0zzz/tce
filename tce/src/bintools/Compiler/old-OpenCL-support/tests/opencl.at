AT_SETUP([kernel detection & processing])

AT_DATA([main.c], [
#include <stdlib.h>

void __KERNEL_f(void *i);

int main(int argc, char *argv[[]]) {
    int i[[32]];

    __KERNEL_f(i);

    return 0;
}
])

AT_DATA([context.c], [
#include <stdio.h>

void g(void) {
    puts("OK");
}

void __KERNEL_f(void) {
    g();
}
])

$LLVMCC $LLVMCFLAGS -c --emit-llvm main.c
$LLVMCC $LLVMCFLAGS -c --emit-llvm context.c
AT_CHECK([opt -load=$abs_top_builddir/lib/.libs/llvmopencl.so \
          -add-context -flatten-kernels \
          -opencl -warp-width=2 1 1 \
          -loop-count=2 1 1 -external-functions=puts \
          -f -o opencl_context.o context.o])
AT_CHECK([llvm-link -o test.o main.o opencl_context.o])
AT_CHECK([lli test.o], 0, [OK
OK
OK
OK
])

AT_CLEANUP

#------------------------------------------------------------------------------

AT_SETUP([kernel size parsing])

AT_DATA([main.c], [
#include <stdlib.h>

void __KERNEL_4_3_2_f(void *i);

int main(int argc, char *argv[[]]) {
    int i[[32]];

    __KERNEL_4_3_2_f(i);

    return 0;
}
])

AT_DATA([context.c], [
#include <stdio.h>

void g(void) {
    puts("OK");
}

void __KERNEL_4_3_2_f(void) {
    g();
}
])

$LLVMCC $LLVMCFLAGS -c --emit-llvm main.c
$LLVMCC $LLVMCFLAGS -c --emit-llvm context.c
AT_CHECK([opt -load=$abs_top_builddir/lib/.libs/llvmopencl.so \
          -add-context -flatten-kernels \
          -opencl -external-functions=puts \
          -f -o opencl_context.o context.o])
AT_CHECK([llvm-link -o test.o main.o opencl_context.o])
AT_CHECK([lli test.o], 0, [OK
OK
OK
OK
OK
OK
OK
OK
OK
OK
OK
OK
OK
OK
OK
OK
OK
OK
OK
OK
OK
OK
OK
OK
])

AT_CLEANUP

