AT_SETUP([region splitting actually changes code])

AT_DATA([test.c], [
#include <stdio.h>

int main(int argc, char *argv[[]]) {
    printf("OK\n");

    return 0;
}
])

$LLVMCC $LLVMCFLAGS -c --emit-llvm test.c
opt -strip test.o | llvm-dis -o strip_test.ll
AT_CHECK([opt -load=$abs_top_builddir/lib/.libs/llvmopencl.so -split-regions \
          -strip test.o | llvm-dis -o opencl_test.ll])
AT_CHECK([cmp opencl_test.ll strip_test.ll], 1, ignore)

AT_CLEANUP

#-------------------------------------------------------------------------------

AT_SETUP([region splitting maintains functionality])

AT_DATA([test.c], [
#include <stdio.h>

int main(int argc, char *argv[[]]) {
    printf("OK\n");

    return 0;
}
])

$LLVMCC $LLVMCFLAGS -c --emit-llvm test.c
AT_CHECK([opt -load=$abs_top_builddir/lib/.libs/llvmopencl.so -split-regions \
          -f -o opencl_test.o test.o])
AT_CHECK([lli opencl_test.o], 0, [OK
])

AT_CLEANUP

#-------------------------------------------------------------------------------

AT_SETUP([region splitting is reversible])

AT_DATA([test.c], [
#include <stdio.h>

int main(int argc, char *argv[[]]) {
    printf("OK\n");

    return 0;
}
])

$LLVMCC $LLVMCFLAGS -c --emit-llvm test.c
opt -std-compile-opts -strip test.o | llvm-dis -o std_strip_test.ll
AT_CHECK([opt -load=$abs_top_builddir/lib/.libs/llvmopencl.so -split-regions \
          -std-compile-opts -strip test.o | llvm-dis -o std_opencl_test.ll])
AT_CHECK([cmp std_opencl_test.ll std_strip_test.ll])

AT_CLEANUP