#!/usr/bin/env python
#
# Compiler driver for tce-llvm-gcc toolset
#

import os, sys, commands, optparse, shutil, glob, signal
import os.path

from tempfile import mkdtemp
from optparse import OptionParser
from shutil import rmtree

# global variables...
debugMode = False
options = None
newlib_libdir=""
newlib_includes=""
lowerintrinsicsplugin=""

def handler(signum, frame):
    cleanup(tempDir)
    sys.exit(2)

def cleanup(tmpDir):
    """Removes temporary files created during build."""
    if options.leave_dirty == False:
        rmtree(tmpDir, ignore_errors=True)
    else:
        sys.stdout.write("Intermediate files left in build dir " +\
                         tmpDir + "\n")

def tryRemove(filename):
    """Tries to remove a file."""
    try:
        os.remove(filename)
    except:
        pass

def runCommand(command, echoOutput):
    """Runs a command and prints everything if requested."""

    if echoOutput:
        print command

    (exitCode, output) = commands.getstatusoutput(command)

    if echoOutput:
        print output

    return (exitCode, output)
    

# TODO: add support for ll and check if file is .bc object from magic number...
def processInputFiles(inFiles, tmpDir, verbose):
    
    """ Compiles input files to .bc files and returns list
    cotaining all the files to link together.
    """

    compileFlags=newlib_includes

    if options.compile_only:
        compileFlags += "-c "

    if options.g_cc_switch:
        compileFlags += "-g "

    for i in options.defines:
        compileFlags += "-D" + i + " "

    for i in options.include_dirs:
        compileFlags += "-I" + i + " "

    for i in options.B_cc_switches:
        compileFlags += "-B" + i + " "
        
    for i in options.f_cc_switches:
        compileFlags += "-f" + i + " "

    for i in options.isystem_cc_switches:
        compileFlags += "-isystem" + i + " "

    # list of valid suffixes
    knownSuffices = [".cpp", ".cc", ".c", ".bc", ".o", ".a"]

    linkList = []

    # Compile input files if needed
    if len(inFiles) == 0:
        exitWithError(
            1, verbose,
            "There must be at least one .bc, .c, .cc or .cpp file given.\n")
    else: 
        for fName in inFiles:
            # check file type based on knownSuffices
            baseName = ""
            suffix = ""
            for i in range(len(knownSuffices)):
                testSuffix = knownSuffices[i]
                suffixStart = fName.rfind(testSuffix)

                if suffixStart != -1:
                    suffix = fName[suffixStart:len(fName)]
                    baseName = fName[0:suffixStart]

                    if suffix == testSuffix:
                        break
                    else:
                        baseName = ""
                        suffix = ""
            
            if baseName != "" and suffix != "":
                # gen command for compiling, for files that need to
                # be compiled first
                command = ""
                
                # After compilation all malloc instructions are lowered
                # to function calls... if malloc function
                # is implemented as a instruction in llvm assembler,
                # it won't be linked to final binary from libc.a
                # (ld knows how to select only needed parts from libc.a,
                # even thoug it does it very bad, it shorten optimizetime)
                outFileName = tmpDir + "/" + os.path.basename(baseName) + ".o"
                if suffix == ".c":                    
                    command = "tce-llvm-gcc --emit-llvm -O2 -ffreestanding "\
                              "-fno-unit-at-a-time -fno-inline -c -I" + tmpDir +\
                              " " + compileFlags + baseName + suffix + " -o " +\
                              outFileName + ".tobelowered;"  

                    command += lowerMemIntrinsicCommand(outFileName + ".tobelowered", outFileName)
                    
                   
                elif suffix == ".cpp" or suffix == ".cc":
                    command = "tce-llvm-g++ --emit-llvm -O2 -ffreestanding "\
                              "-fno-unit-at-a-time -fno-inline -c -I" + tmpDir +\
                              " " + compileFlags + baseName + suffix + " -o " +\
                              outFileName + ".tobelowered;" 

                    command += lowerMemIntrinsicCommand(outFileName + ".tobelowered", outFileName)

                elif suffix == ".bc":
                    exitWithError(
                        1, verbose,
                        "Bytecode files can't be relinked. "
                        "Use .o suffix for unlinked bytecode files.\n")

                elif suffix == ".o":
                    outFileName =  fName

                elif suffix == ".a":
                    outFileName = fName

                # add all files to list for linkage
                linkList += [outFileName]

                if command != "":                    
                    (exitCode, output) = runCommand(command, verbose)
                    if exitCode != 0:
                        exitWithError(
                            1, verbose,
                            "Error while compiling file: " +\
                            baseName + suffix + "\n" + output + "\n")
            else:
                exitWithError(
                    1, verbose,\
                    "Unknown input file type: " +\
                    fName + ". Supported file types " +\
                    str(knownSuffices) + "\n")
    return linkList

def exitWithError(status, alreadyVerbose, output):
    if not alreadyVerbose:
        sys.stderr.write(output + "\n")
    cleanup(tempDir)
    sys.exit(status)


def lowerMemIntrinsicCommand(srcFile, dstFile):
    commandp = "opt -load=" + lowerintrinsicsplugin + " -lowerintrinsics "
    command = commandp + " -o " + dstFile + " " + srcFile
    return command
    
###
# Links bytecode files and returns name of the linked file.
##
def linkBytecode(linkFiles, fileNamePrefix, verbose):

    startFiles = os.path.join(newlib_libdir,"crt0.o ")

    libNoSys = os.path.join(newlib_libdir,"libnosys.a")
    if not os.path.exists(libNoSys):
        libNoSys = ""

    # libm must be linked first to make sure that necessary parts of libc will be linkend in (e.g. errno)
    endFiles = (os.path.join(newlib_libdir,"libm.a") + " " +
                os.path.join(newlib_libdir,"libc.a") + " " +
                libNoSys + " " +
                os.path.join(newlib_libdir,"crtend.o") + " ")


    linkedFileName = fileNamePrefix + "_linked"
    #### Link all binary code together
    command = "llvm-ld -disable-opt -o " + linkedFileName + " " + startFiles
    for name in linkFiles:
        command += " " + name

    command += " " + endFiles

    (exitCode, output) = runCommand(command, options.verbose)
    if exitCode != 0:
        sys.stderr.write("Error while linking bytecode: " + command + "\n")
        exitWithError(1, verbose, output)

    # remove annoying autogenerated script.
    tryRemove(linkedFileName)

    return linkedFileName + ".bc"

####
# Optimizes linked bc. Returns name of the optimized file.
#
# You can check default switches with command:
# opt -O3 -debug-pass=Arguments systemtest/bintools/Scheduler/tests/QuickTests/HelloWorld/program.bc
###
def optimizeBytecode(inFile, fileNamePrefix):

    verbose = options.verbose

    if options.unroll_threshold > 0:
        loop_unroll_switches = \
            " -unroll-allow-partial -unroll-threshold=%d " % \
            options.unroll_threshold
        loop_unroll_pass = "-loop-unroll "
    else:
        loop_unroll_pass = " " 
        loop_unroll_switches = " " 

    if options.noinline:
        inline = ""
    else:
        inline = "-inline "

        
    std_compile_opts = (" " +
                        "-preverify " +
                        "-domtree " +
                        "-verify " +
                        "-lowersetjmp " +
                        "-raiseallocs " +
                        "-simplifycfg " +
                        "-domtree " +
                        "-domfrontier " +
                        "-mem2reg " +
                        "-globalopt " +
                        "-globaldce " +
                        "-ipconstprop " +
                        "-deadargelim " +
                        "-instcombine " +
                        "-simplifycfg " +
                        "-basiccg " +
                        "-prune-eh " +
                        "-functionattrs " +
                        inline +
                        "-argpromotion " +
                        "-simplify-libcalls " +
                        "-instcombine " +
                        "-jump-threading " +
                        "-simplifycfg " +
                        "-domtree " +
                        "-domfrontier " +
                        "-scalarrepl " +
                        "-instcombine " +
                        "-break-crit-edges " +
                        "-condprop " +
                        "-tailcallelim " +
                        "-simplifycfg " +
                        "-reassociate " +
                        "-domtree " +
                        "-loops " +
                        "-loopsimplify " +
                        "-domfrontier " +
                        "-scalar-evolution " +
                        "-lcssa " +
                        "-loop-rotate " +
                        "-licm " +
                        "-lcssa " +
                        "-loop-unswitch " +
                        "-scalar-evolution " +
                        "-lcssa " +
                        "-loop-index-split " +
                        "-instcombine " +
                        "-scalar-evolution " +
                        "-lcssa " +
                        "-indvars " +
                        "-scalar-evolution " +
                        "-lcssa " +
                        "-loop-deletion " +
                        "-domfrontier " +
                        "-lcssa " +
                        loop_unroll_pass +
                        "-instcombine " +
                        "-memdep " +
                        "-gvn " +
                        "-memdep " +
                        #"-memcpyopt " +
                        "-sccp " +
                        "-instcombine " +
                        "-break-crit-edges " +
                        "-condprop " +
                        "-domtree " +
                        "-memdep " +
                        "-dse " +
                        "-adce " +
                        "-simplifycfg " +
                        "-strip-dead-prototypes " +
                        "-print-used-types " +
                        "-deadtypeelim " +
                        "-constmerge " +
                        "-simplifycfg " +
                        "-domtree " +
                        "-domfrontier " +
                        "-mem2reg " +
                        "-instcombine " +
                        "-simplifycfg " +
                        "-basiccg " +
                        inline +
                        "-argpromotion " +
                        "-simplify-libcalls " +
                        "-instcombine " +
                        "-jump-threading " +
                        "-simplifycfg " +
                        "-domtree " +
                        "-domfrontier " +
                        "-scalarrepl " +
                        "-instcombine " +
                        "-break" +
                        "-crit" +
                        "-edges " +
                        "-condprop " +
                        "-tailcallelim " +
                        "-simplifycfg " +
                        "-reassociate " +
                        "-domtree " +
                        "-loops " +
                        "-loopsimplify " +
                        "-domfrontier " +
                        "-scalar-evolution " +
                        "-lcssa " +
                        "-loop-rotate " +
                        "-licm " +
                        "-lcssa " +
                        "-loop-unswitch " +
                        "-scalar-evolution " +
                        "-lcssa " +
                        "-loop-index" +
                        "-split " +
                        "-instcombine " +
                        "-scalar-evolution " +
                        "-lcssa " +
                        "-indvars " +
                        "-scalar-evolution " +
                        "-lcssa " +
                        "-loop-deletion " +
                        "-domfrontier " +
                        "-lcssa " +                       
                        loop_unroll_pass +
                        "-instcombine " +
                        "-memdep " +
                        "-gvn " +
                        "-memdep " +
                        #"-memcpyopt " +
                        "-sccp " +
                        "-instcombine " +
                        "-break-crit-edges " +
                        "-condprop " +
                        "-domtree " +
                        "-memdep " +
                        "-dse " +
                        "-adce " +
                        "-simplifycfg " +
                        "-domtree " +
                        "-loops " +
                        "-loopsimplify " +
                        "-domfrontier " +
                        "-scalar-evolution " +
                        "-lcssa " +
                        loop_unroll_pass +
                        "-preverify " +
                        "-verify " +
                        loop_unroll_switches +
                        " ")
       
    # -O0 optimization doesn't exists in opt
    optSwitches = ""
    if options.optimization_level == 0:
        options.sequential_schedule = True

    elif options.optimization_level == 1:
        optSwitches = (std_compile_opts)
        
    elif options.optimization_level > 1:
        optSwitches = (" -internalize " + std_compile_opts)
    
    internalize_api_list = " -internalize-public-api-list=_start"
    if options.keep_symbols != "":
        internalize_api_list += "," + options.keep_symbols

    optSwitches += internalize_api_list

    if options.noinline:
        optSwitches += " -disable-inlining"

    outputName = fileNamePrefix + "_optimized.bc"
        
    command = "opt -f " + inFile + " -o " +\
              outputName +\
              optSwitches

    if verbose:
        debugCommand = ("opt -f -debug-pass=Arguments " + inFile + " -o " +
                        outputName + optSwitches)
        (exitCode, output) = runCommand(debugCommand, verbose)

    (exitCode, output) = runCommand(command, verbose)

    if exitCode != 0:
        sys.stderr.write("Error while optimizing bytecode: " + command + "\n")
        exitWithError(1, verbose, output)

    return outputName

####
# Link emulation function bytecode to program.
###
def linkEmulationFuncs(inFile, fileNamePrefix):

    verbose = options.verbose

    # if software floatingpoint should be lowered, link the emulation functions in
    emulationLib = os.path.join(newlib_libdir,"float_emulation.o") + " "
    linkedName = fileNamePrefix + "_libemul.bc"
        
    command = ("llvm-link -f " + inFile + " " + emulationLib + " -o " + linkedName)

    (exitCode, output) = runCommand(command, verbose)

    if exitCode != 0:
        sys.stderr.write("Error while linking emulation lib: " + command + "\n")
        exitWithError(1, verbose, output)

    outputName = fileNamePrefix + "_emul_internalized.bc"


    internalize_api_list = " -internalize-public-api-list=_start"
    if options.keep_symbols != "":
        internalize_api_list += "," + options.keep_symbols
    
    no_inline = ""
    if options.noinline:
        no_inline = " -disable-inlining"

    command = ("opt " + linkedName + no_inline +
               " -f -internalize " + internalize_api_list + " -o " + outputName)

    (exitCode, output) = runCommand(command, verbose)

    if exitCode != 0:
        sys.stderr.write("Error while internalizing emulation functions: " + command + "\n")
        exitWithError(1, verbose, output)

    return outputName

#############################################
# Main program
#############################################

# Options..
usage = "usage: %prog [options] source-or-bc-file1 source-or-bc-file2 ..."

p = optparse.OptionParser(usage)

p.add_option('-a', '--adf-file',
             type="string", action="store", metavar='file',
             dest="adf_file", default="",
             help="Architecture which for program is scheduled after "
             "the compilation. Note that 'schedule' must be installed.")

p.add_option('-s', '--scheduler-config',
             type="string", action="store", metavar='file',
             dest="scheduler_config", default=None,
             help="Configure file for scheduling command.")

p.add_option('-O', '--optimization-level',
             type="int", action="store", metavar='level',
             dest='optimization_level', default=0,
             help="Optimization level. 0=no optimizations, "
             "1=preserve program API, 2=don't respect original API, "
             "3 = same that 2. NOTE: For optimal floating point performance,"
             "this switch must be given also when compiling bc files to tpef.")

p.add_option('-k', '--keep-symbols',
             type="string", action="store",
             metavar='sym1,sym2,sym3', dest='keep_symbols', default="",
             help="List of symbols whose optimization away is prevented. "
             "If you are using this, remember to define "
             "at least 'main' symbol.")

p.add_option('-o', '--output-name',
             type="string", action="store", metavar='file',
             dest="output_name", default="",
             help="File name for output binary.")

p.add_option('-d', '--leave-dirty', action="store_true",
             dest='leave_dirty', default=False,
             help="Do not delete files from each compilation phase.")

p.add_option('-c', '--compile-only', action="store_true",
             dest='compile_only', default=False,
             help="Compile only do not link or optimize.")

p.add_option('-v', '--verbose', action="store_true",
             dest='verbose', default=False,
             help="Print out commands and outputs for each phase.")

p.add_option('-D', '--preprocessor-define', 
             type="string", action="append", metavar='string',
             dest="defines", default=[],
             help="Passed to gcc.")

p.add_option('-I', '--include-directory', 
             type="string", action="append", metavar='directory',
             dest="include_dirs", default=[],
             help="Passed to gcc.")

p.add_option('-L', '--library-directory', 
             type="string", action="append", metavar='directory',
             dest="lib_dirs", default=[],
             help="Passed to gcc.")

p.add_option('-l', '--library-link', 
             type="string", action="append", metavar='libname',
             dest="libs", default=[],
             help="Converted to static link command. i.e. -lpthread  => /llvm-install/tce-llvm/lib/libpthread.a")

p.add_option('-W', '--warning', 
             type="string", action="append", metavar='type',
             dest="warnings", default=[],
             help="Ignored.")

p.add_option('--plugin-cache-dir',
             type="string", action="store", metavar='directory',
             dest="plugin_cache_dir",
             default=os.path.expanduser("~/.tce/tcecc/cache"),
             help="Directory for cached llvm target plugins.")

p.add_option('--no-plugin-cache', action="store_true",
             dest="no_cache", default=False,
             help="Do not cache generated llvm target plugins.")

p.add_option('--no-schedule', action="store_true",
             dest="no_schedule", default=False,
             help="Do not call scheduler.")

p.add_option('--clear-plugin-cache', action="store_true",
             dest="clear_cache", default=False,
             help="Clear plugin cache completely.")

p.add_option('--disable-inlining', action="store_true",
             dest="noinline", default=False,
             help="Disable function inlining.")

p.add_option('--unroll-threshold',
             type="int", action="store", metavar='LLVM_INSTRUCTION_COUNT',
             dest='unroll_threshold', default=100,
             help="Unroll loops in case the unrolled loop body size will be less " + \
             "than the given number of LLVM instructions. Use 0 to disable " + \
             "loop unrolling.")

p.add_option('--sequential-schedule', action="store_true",
             dest="sequential_schedule", default=False,
             help="Runs sequential scheduler for compiled code.")

p.add_option('--debug', action="store_true",
             dest="debug", default=False,
             help="Print LLVM debug data.")

p.add_option('--isystem', 
             type="string", action="append", metavar='directory',
             dest="isystem_cc_switches", default=[],
             help="Passed to gcc as -system switch. Also -isystem is supported.")

p.add_option('-B', 
             type="string", action="append", metavar='directory',
             dest="B_cc_switches", default=[],
             help="Passed to gcc.")

p.add_option('-f', 
             type="string", action="append", metavar='opt_var',
             dest="f_cc_switches", default=[],
             help="Passed to gcc.")

p.add_option('-g', 
             type="string", action="store", metavar='store_true',
             dest="g_cc_switch", default=False,
             help="Passed to gcc.")

p.add_option('--max-thread-latency',
             type="int", action="store", metavar='usec',
             dest='max_thread_latency',
	     default=None,
             help=\
"""Emit sched_yield() calls to the program to produce given maximum thread
switch latency (in microseconds). In case the target does not have the RTIMER
operation, sched_yield() is called in every basic block unconditionally, 
producing considerable additional overhead to the program exectuion.""")

# Commandline argument parsing

# fix gcc switches, which cannot be represented in OptionParser format by adding extra "-" before switch
args = []
for opt in sys.argv[1:]:
    if opt.startswith("-isystem"): opt = "-" + opt
    args.append(opt)

# parse valid args
options, inFiles = p.parse_args(args)

# create temp dir
tempDir = mkdtemp("","tcecc-")

# assign signal handlers to exit cleanly
signal.signal(signal.SIGHUP, handler)
signal.signal(signal.SIGTSTP, handler)

# clear plugin cache and do nothing else if the --clear-plugin-cache
# option is given
if options.clear_cache:
    pluginFiles = glob.glob(options.plugin_cache_dir + '/*.so')
    for fName in pluginFiles:
        tryRemove(fName)

    sys.stdout.write("Cleared plugin cache.\n")
    cleanup(tempDir)
    sys.exit(0)

if len(inFiles) == 0:
    p.print_help()
    cleanup(tempDir)
    sys.exit(1)

if options.output_name == "":
    # configure checks sometimes check if a.out is created by default..
    # (pth lib at least)
    outputName = "a.out"
else:
    outputName = options.output_name

### llvm-gcc install prefix
(exitCode, output) = runCommand("dirname `which tce-llvm-gcc`", False)
if exitCode != 0:
    sys.stderr.write("Could not find 'tce-llvm-gcc'. Have you installed it in PATH?\n")
    exitWithError(1, options.verbose, output)

### tce install prefix
(exitCode, output) = runCommand("tce-config --prefix", False)
if exitCode != 0:
    tceInstalled = False
else:
    tceInstalled = True
    tceprefix = output
    
## check if we are running from the TCE source tree in which case use only
## source tree libraries and binaries
scriptDir = os.path.abspath(os.path.dirname(sys.argv[0]))
runningInstalled = 'src/bintools/Compiler' not in scriptDir

if runningInstalled:
    lowerintrinsicsplugin = os.path.join(tceprefix,"lib/tce/LowerIntrinsics.so")
    newlib_libdir = os.path.join(tceprefix,"tce-llvm/lib")
    newlib_includes = "-isystem " + os.path.join(tceprefix,"tce-llvm/include") + " "
    #srcRoot = None
else:
    #srcRoot = scriptDir.split('bintools/Compiler')[0]
    lowerintrinsicsplugin = os.path.join("@abs_top_builddir@", "src/applibs/LLVMBackend/passes/.libs/LowerIntrinsics.so")
    newlib_libdir = os.path.join("@abs_top_builddir@","newlib-1.17.0/tce-llvm/newlib")
    newlib_includes = ("-isystem " + os.path.join("@abs_top_srcdir@","newlib-1.17.0/tce-llvm/newlib/targ-include") +
                       " -isystem " + os.path.join("@abs_top_srcdir@","newlib-1.17.0/newlib/libc/include") +
                       " -isystem " + os.path.join("@abs_top_srcdir@","newlib-1.17.0/newlib/libm/include") + " ")

if options.verbose:
    if runningInstalled:
        print "Running installed TCE from PATH."    
    else:
        print "Running from a TCE build tree rooted at '%s'." % "@abs_top_builddir@"
    
    
namePrefix = tempDir + "/" + os.path.basename(outputName)

if options.compile_only and options.output_name != "" and len(inFiles) > 1:
    sys.stdout.write("Cannot specify -o  with -c and multiple input files.\n")
    cleanup(tempDir)
    sys.exit(1)

elif len(inFiles) == 1 and inFiles[0][-3:] == ".bc":
    # Only one .bc inputfile given. No need to compile, link or optimize anything.
    # Note: Already linked bytecode can't be linked or optimized
    # with -lowermissing again anyway!
    optimizedFileName = inFiles[0]
else:
    # Compile, link and optimize input files.
    
    # generate tceops.h
    if runningInstalled:
        tceopgen = "tceopgen"
    else:
        tceopgen = "@abs_top_builddir@" + "/src/bintools/Compiler/tceopgen/tceopgen"
        
    (exitCode, output) = runCommand(
        tceopgen + " -o " + tempDir + "/tceops.h" , options.verbose)
    
    if exitCode != 0:
        sys.stderr.write("Error while generating custom operation macros:\n")
        exitWithError(1, options.verbose, output)
    
    linkList = processInputFiles(inFiles, tempDir, options.verbose)

    # if only compiling
    if options.compile_only:
        if options.output_name != "":
            (exitCode, output) = runCommand(
                "mv " + linkList[0] + " " + options.output_name,
                options.verbose)

        else:
            cmd = "mv "
            for fName in linkList:
                cmd += fName + " "
            cmd += "."
            (exitCode, output) = runCommand(cmd, options.verbose)

        cleanup(tempDir)
        sys.exit(0)

    # lower memset intrinsics
    # loweredList = lowerMemIntrinsics(linkList, options.verbose)
    # linkedFileName = linkBytecode(loweredList, namePrefix, options.verbose)

    # convert -l switches to static library link commands.
    for i in options.libs:
        linkList.append(newlibprefix + "/lib%s.a" % i)
    
    linkedFileName = linkBytecode(linkList, namePrefix, options.verbose)

    # optimize
    optimizedFileName = optimizeBytecode(linkedFileName, namePrefix)

    if (options.adf_file == ""):
        (exitCode, output) = runCommand(
            "mv " +  optimizedFileName + " " + outputName,
            options.verbose)
        
#### Schedule compiled sequential code for machines
if options.adf_file != "":

    outFile = outputName
    seqFile = tempDir + "/" + os.path.basename(outFile) + ".seq"

    # optimize and lower flaotingpoint
    emulationLinkedFileName = linkEmulationFuncs(optimizedFileName, namePrefix)

    if options.sequential_schedule or options.optimization_level == 0:
        scheduler_config_file_name = "sequential_tcecc_scheduler.conf"
    else:
        scheduler_config_file_name = "default_scheduler.conf"        
        
    if options.no_schedule is False and options.scheduler_config is None:
        if runningInstalled:
            options.scheduler_config = (tceprefix +
                                        "/share/tce/scheduler/passes/" +
                                        scheduler_config_file_name)
        else:
            options.scheduler_config = os.path.normpath("@abs_top_srcdir@" +
                                                        "scheduler/passes/" +
                                                        scheduler_config_file_name)

    #### Compile to unscheduled mixed code for the target architecture
    if not runningInstalled:
        command = "@abs_top_builddir@" + "/src/bintools/Compiler/llvm-tce/llvm-tce"
    else:
        command = "llvm-tce"

    if options.verbose:
        command += " -v"
        
    if options.debug:
        command += " --debug"

    if options.no_schedule is False:
        command += " -c " + options.scheduler_config

    stdEmulationLib = os.path.join(newlib_libdir, "standard_emulation.o ")

    command += (" -a " + options.adf_file +
                " -o " + outFile +
                " -O" + str(options.optimization_level) +
                " -e" + stdEmulationLib +
                " " + emulationLinkedFileName)
    
    if options.max_thread_latency is not None:
	    # Temporary hack until 'schedule' supports passing cmdline
	    # options to passes.
	    import os
	    os.environ['MAX_THREAD_SWITCH_LATENCY'] = \
            str(options.max_thread_latency)
    
    (exitCode, output) = runCommand(command, options.verbose)
    if exitCode != 0:
        sys.stderr.write("Error while compiling " + command + "\n")
        exitWithError(1, options.verbose, output)


#### Cleanup trashes
cleanup(tempDir)
